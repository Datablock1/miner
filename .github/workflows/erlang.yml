name: Erlang CI

on:
  push:
    branches: [ master ]

jobs:

  build:

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set Env
      run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:10})
    - name: Compile Miner from Source
      shell: bash
      run: |
        sudo apt-get update -y && sudo apt-get install -y libgtk2.0-0 zip
        wget https://packages.erlang-solutions.com/erlang/debian/pool/esl-erlang_22.3.1-1~ubuntu~bionic_amd64.deb
        wget http://mirrors.kernel.org/ubuntu/pool/universe/w/wxwidgets3.0/libwxgtk3.0-0v5_3.0.4+dfsg-3_amd64.deb
        sudo apt install -y libdbus-1-dev autoconf automake libtool flex libgmp-dev cmake libsodium-dev libssl-dev bison libsnappy-dev libclang-dev doxygen make cargo g++ libsctp1 libncurses5 libwxbase3.0-0v5 build-essential cmake libdbus-1-dev mosh vim parallel
        sudo dpkg -i libwxgtk3.0-0v5_3.0.4+dfsg-3_amd64.deb
        sudo apt update -y
        sudo dpkg -i esl-erlang_22.3.1-1~ubuntu~bionic_amd64.deb
        sudo apt-get install -y -f
        ./rebar3 as validator release
        zip -r build_$RELEASE_VERSION.zip _build
    - uses: shallwefootball/s3-upload-action@master
    - name: Deploy to S3
      with:
        aws_key_id: ${{ secrets.AWS_KEY_ID }}
        aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
        aws_bucket: ${{ secrets.AWS_BUCKET }}
        source_dir: 'dirname'



        



        


